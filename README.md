# Crypto_Alert

# DESCRIPTION
An ETL pipeline built in AWS that alerts you in real-time if any cryptocurrency had a major change in price in the past 3 days. It calls the CoinPaprika API and creates a view that returns alert messages in the cases where, in the last 3 days:

-A coin changed its price by 10% or more in the last 24h

-A coin changed its price by 7% or more in the last 12h

-A coin changed its price by 5% or more in the last 4h

-A coin changed its price by 3% or more in the last hour

# 1. STORING THE API CALLS

The lambda function crypto-project-dump-250coins-in-S3.py under the lambda_functions folder calls the CoinPaptrika API and generates a .csv file with 250 rows and two columns that contains the prices of 250 cryptocurrencies at the moment the function was called. The .csv file is added in an S3 bucket in AWS. This lambda function is scheduled to run every 5 minutes, and each 5 minutes, a new .csv file is created. The timestamp at which the .csv files are created is part of their names.

# 2. CREATING THE RAW DATA TABLES

A database was created in Athena called crypto_project that contains two objects:

a). The raw_prices table

b). The raw_prices_with_ts view

The script for the creation of both of those objects can be found in the Athena folder in this repo. The raw_prices table appends all the .csv files to create one giant SQL table with two columns. The raw_prices_with_ts view takes all the data from the raw_prices table and adds a third column, the timestamp, describing the time at which that cryptocurrency had that certain price.

# 3. CREATING THE STAR SCHEMA

A new database was created in Athena called crypto_star_schema composed of multiple views and tables.

a). D_Coin is a dimension table with two columns containing each of the 250 cryptocurrencies and a unique id for each of them. This table is populated by a Glue job that is triggered on demand (and which I avoid to trigger as much as possible since glue jobs are extremely expensive... if the price of AWS was not a problem I would've done the entire project in Glue).

b). D_Time is a time look-up dimension table generated in Athena that contains every single date between 2020-01-01 and 2060-12-31 with its respective day, month_no, year and month_text.

c). F_Price is the main fact table of this star schema, which is actually a view, since it's cheaper to maintain this way. It contains a unique ID, the id of the coin (FK to D_Coin), the date (FK to D_Time), a price in USD and the hour, minute and timestamp at which that particular coin had a particular price.

# 4. ADDITIONAL VIEWS AND TABLES

a). The view alert_view was defined to return the coins whose prices changed drastically in a short period of time. It returns the name of the coins, last price of each coin (with a delay of 5 minutes at most) and the percentage change in price in the last 24h, 12h, 4h and 1h as well as a column describing which kind of threshold they passed in order to be returned by this view in the first place:
![image](https://github.com/user-attachments/assets/dba860d7-3459-40ca-8976-07b98532cadd)

b). The table alert_history (stored as a PARQUET file in an S3 bucket) was created to insert all the values generated by the alert_view table in order to also have historical data. The idea is that alert_view only returns the coins that passed this threshold _right now_, while alert_history is a table that records historical data as well (coins that may have crossed thresholds in the past but no longer do, as well as the timestamp when they did cross it). 

c). The Athena script Load_alert_history is an INSERT INTO statement that inserts the values from the alert_view into the alert_history table. This SQL script is triggered by the lambda function crypto-project-run-load-alert-history.py which is scheduled to run every 10 minutes.

d). Finally, the view text_alerts has only one column with strings that represent the actual alerts in alert_history from the past 3 days, and it looks like this:
![image](https://github.com/user-attachments/assets/1e8c859b-7dbb-4e7e-9ea1-09d1a6c30793)

